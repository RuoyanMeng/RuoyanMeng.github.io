<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Using HTML Canvas generate poster and problems solving</title>

    <!-- Bootstrap Core CSS -->
    <link href="../lib/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="../css/style.css" rel="stylesheet">
    <link href="../css/prism.css" rel="stylesheet" />

    <!-- Custom Fonts -->
    <script src="https://kit.fontawesome.com/84e52e79f6.js" crossorigin="anonymous"></script>
    <link href="../lib/font-awesome-4/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="../css/font.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono&display=swap" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="../lib/support/html5shiv.js"></script>
        <script src="../lib/support/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <!-- Navigation -->

    <!-- Header -->
    <header id="top" class="header" style="height: 240px;">
        <div class="bg-post">
            <div class="row">
                <a href="#blog" class="btn btn-dark btn-lg" style="float: left;" onclick="history.back()"></i> &lt;--
                    Back</a>
            </div>
            <div class="post-vertical-center row" style="font-family: 'Roboto Mono', monospace;vertical-align: middle;">
                <h3>Using HTML Canvas generate poster and problems solving </h1>
                    <br>
                    <h4 class="subtitle">Ruoyan Meng</h4>
            </div>
        </div>
    </header>

    <!--content-->
    <section id="blog" style="color: white; background-color: black; font-family: 'Roboto Mono', monospace;"
        class="services">
        <div class="container" style="z-index: 1; ">
            <div class="row">
                <p>The idea of generating a poster by HTML Canvas comes from a personal project called <a href="https://lyrics-crawler.herokuapp.com/">Lyrics-Crawler</a>,
                    which helps Spotify users fetch lyrics easily. To help users sharing pieces of lyrics I decided to
                    generate lyrics card.</p>
                <p>Convert DOM elements into SVG or intto Canvas then download as raster (PNG or JPEG) images are the
                    most
                    common methods for poster generating. Js libraries <a
                        href="https://github.com/tsayen/dom-to-image">dom-to-image</a> and <a
                        href="https://github.com/niklasvh/html2canvas">html2canvas</a> have provided
                    solutions to the above methods. However, the picture generated by these two libraries is
                    unsatisfied. So I start programming my own method.</p>
                <p>
                    My idea follows drawing required elements to Canvas then using web API <a
                        href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLCanvasElement/toDataURL">HTMLCanvasElement.toDataURL()</a>
                    save
                    canvas as pictures.
                </p>
                <p>
                    There are two main problems encountered during the implementation process:
                </p>
                <p style="color:bisque;">
                    <B> <i>1. The generated image and text are blurry</i> </B>
                </p>
                <p style="color:bisque;">
                    <B> <i>2. HTML5 canvas.fillText() won't do line breaks</i> </B>
                </p>
                <p>Solution will talk later.</p>
                <p>The lyrics card is generated dynamically, the width can be set in advance. To get the height of it,
                    using React Refs to get the DOM size after the first render.</p>
                <p>
                    <pre>
                <code class="language-jsx" style="font-size: small; ">
                import React, { Component } from "react";
                class LyricsPic extends Component {
                    constructor(props) {
                        super(props);
                            this.state = {
                                dimensions: null,
                                };
                        }
                        componentDidMount() {
                            this.setState({
                                dimensions: {
                                    width: this.card.offsetWidth,
                                    height: this.card.offsetHeight,
                                    },
                                });
                            }
                        render() {
                            let card =
                                &lt;div className='card' id='card' ref={el => { this.card = el }}>
                                &lt;/div>
                                return (
                                    {card}
                                    &lt;canvas id="canvas" ref={el => { this.canvas = el }} style={{ display: 'none' }}>&lt;/canvas>
                                )
                            }
                        </code>
                    </pre>
                </p>
                <p>
                    After getting the dimension information, using it to draw a corresponding Canvas.
                </p>
                <p>
                    <pre>
                        <code class="language-javascript" style="font-size: small; ">
                    // *2 to render high-resolution pic, depends on your needs
                    this.canvas.width = dimensions.width*2;
                    this.canvas.height = dimensions.height*2;
                    this.canvas.style.width = dimensions.width*2 + "px";
                    this.canvas.style.height = dimensions.height*2 + "px";
                    var ctx = this.canvas.getContext('2d')
                        </code>
                    </pre>
                </p>
                <p>
                    Then load the image and fill text in Canvas. Set image crossOrigin "anonymous" to allow cross-origin
                    downloading. Adjust text position for every line you add.
                </p>
                <p>
                    <pre>
                    <code class="language-javascript" style="font-size: small; ">
                    //load image
                    var imageObj = new Image();
                    imageObj.crossOrigin = "anonymous";
                    imageObj.onload = () => {
                        ctx.drawImage(imageObj, padding, padding, imageSize, imageSize * imageObj.height / imageObj.width);
                    }
                    
                    //fill text
                    ctx.font = '23px "Roboto Mono"';
                    ctx.fillText("hello world", padding, currentHeight, width);
                    </code>
                </pre>
                </p>
                <p>
                    <i style="color: bisque;">Problem 1.</i> Now every element are in its right place, but the Canvas
                    looks blurry. I'm using Mac and 4K screen, to fit the high-resolution requiement, first get the
                    pixel ratio of current device, then using ratio redraw the canvas.
                </p>
                <p>
                    <pre>
                        <code class="language-javascript" style="font-size: small; ">
                        var getPixelRatio = function (context) {
                            var backingStore = context.backingStorePixelRatio ||
                            context.webkitBackingStorePixelRatio ||
                            context.mozBackingStorePixelRatio ||
                            context.msBackingStorePixelRatio ||
                            context.oBackingStorePixelRatio ||
                            context.backingStorePixelRatio || 1;
                            return (window.devicePixelRatio || 1) / backingStore;
                        };
                        var ratio = getPixelRatio(ctx);
                        
                        // Canvas zoom ratio
                        this.canvas.width = dimensions.width * ratio *2;
                        this.canvas.height = dimensions.height * ratio *2;
                        this.canvas.style.width = dimensions.width *2+ "px";
                        this.canvas.style.height = dimensions.height *2+ "px";
                
                        // After the canvas is enlarged, the corresponding drawing canvas should also be enlarged
                        var ctx = this.canvas.getContext('2d')
                        ctx.scale(ratio, ratio)
                        </code>
                    </pre>
                </p>
                <p>
                    <i style="color: bisque;">Problem 2. Break the line based on the width of your choice, first measure
                        the text wide using <a
                            href="https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/measureText">ctx.measureText(text).width</a></i>,
                    then calculate the ratio of text wide and line width, from this get how many words in this line,
                    recursively, break text into different lines.
                </p>
                <p>
                    <pre>
                        <code class="language-javascript" style="font-size: small; ">
                        let lyricsWidth = Math.round(ctx.measureText(item).width);

                        if (lyricsWidth>=imageSize){
                            let itemWordNum = item.split(" ").length
                            while (item!==""){
                                let wordNum = Math.round(imageSize/lyricsWidth*item.split(" ").length);
                                if(wordNum >= itemWordNum){
                                    currentHeight = currentHeight + lineheight;
                                    ctx.fillText(item, padding, currentHeight, imageSize);
                                    item = "";
                                    break
                                }else{
                                    currentHeight = currentHeight + lineheight;
                                    let newline = item.split(" ").slice(0,wordNum).join(" ");
                                    ctx.fillText(newline, padding, currentHeight, imageSize);
                                    item = item.split(" ").slice(wordNum, lyricsWidth).join(" ");
                                    lyricsWidth = Math.round(ctx.measureText(item).width);
                                }
                            }
                        }else{
                            currentHeight = currentHeight + lineheight;
                            ctx.fillText(item, padding, currentHeight, imageSize)
                        }   
                        </code>
                    </pre>
                </p>
                </p>
                Now the Canvas is ready! Write a function to make it downloadable.
                <p>
                    <pre>
                    <code class="language-javascript" style="font-size: small; ">
                    &lt;a id="download"  onClick={el=>this.download_img(el)} >Download Lyrics Pic&lt;/a>  
                    
                    download_img = (el) => {
                        let time = new Date().getTime()
                        var canvas = document.getElementById('canvas');
                        var image = canvas.toDataURL("image/png");
                        el.target.download = name + "_"+ time + ".png"
                        el.target.href = image;
                    };                  
                        </code>
                    </pre>
                </p>
                <p>
                    Tada, all done!
                </p>
                <p>
                    Check <a href="https://lyrics-crawler.herokuapp.com/">Lyrics-Crawler</a> here!
                </p>
            </div>
        </div>

    </section>




    <!-- Footer -->
    <footer id="contact">
        <div class="foot-container">
            <div class="text-center">
                <div class="avatar" title="Stephen Chow">
                    <a href="https://github.com/RuoyanMeng" target="_blank">
                        <img src="../image/nemo_seagulls.jpg" alt="Avatar">
                    </a>
                </div>

                <h2><strong>Ruoyan Meng</strong></h2>
                <a class="github-button" href="https://github.com/RuoyanMeng" data-size="large" data-show-count="true"
                    aria-label="Follow @Ruoyan Meng on GitHub">Follow @Ruoyan Meng</a>

                <hr class="small">

                <p>Espoo, Finland</p>
                <ul class="list-unstyled">
                    <li class="row-email">
                        <i class="fa fa-envelope-o fa-fw"></i>
                        <a href="mailto:ruoyan.meng@aalto.fi">ruoyan.meng@aalto.fi</a>
                    </li>
                </ul>
                <br>
                <ul class="list-inline">
                    <li>
                        <a href="https://github.com/RuoyanMeng" target="_blank"><i
                                class="fab fa-github fa-fw fa-3x"></i></a>
                    </li>
                    <li>
                        <a href="https://www.linkedin.com/in/ruoyan-meng-3328a1151/" target="_blank"><i
                                class="fab fa-linkedin fa-fw fa-3x"></i></a>
                    </li>
                </ul>

                <hr class="small">

                <hr class="small">
                <p class="text-muted">Copyright &copy; Ruoyan 2019 - <span id="currentYear">2020</span></p>
            </div>
        </div>
        <a id="to-top" href="#top" class="btn btn-dark btn-lg"><i class="fa fa-chevron-up fa-fw fa-1x"></i></a>
    </footer>

    <!-- jQuery -->
    <script type="text/javascript" src="../lib/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script type="text/javascript" src="../lib/bootstrap/3.3.7/bootstrap.min.js"></script>

    <!-- Custom Theme JavaScript -->
    <script type="text/javascript" src="../js/index.js"></script>
    <script src="../js/prism.js"></script>

    <script type="text/javascript" src="../js/count.js"></script>
    <script async defer src="../lib/github-buttons/buttons.min.js"></script>

</body>

</html>